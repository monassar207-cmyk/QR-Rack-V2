<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>QR Rack - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</title>

<!-- PWA Manifest -->
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="QR Rack">
<meta name="theme-color" content="#f59e0b">
<link rel="manifest" href="manifest.json">


<!-- Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(err => {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
  --bg:    #0d1117;
  --card:  #161b27;
  --card2: #1e2535;
  --border:#253047;
  --amber: #f59e0b;
  --amberD:rgba(245,158,11,0.15);
  --amberG:rgba(245,158,11,0.3);
  --green: #10b981;
  --greenD:rgba(16,185,129,0.12);
  --red:   #ef4444;
  --redD:  rgba(239,68,68,0.12);
  --txt:   #dde6f0;
  --txt2:  #8fa3bc;
  --txt3:  #4e637a;
  --r:     12px;
  --rs:    8px;
}

* {
  margin:0;
  padding:0;
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
  -webkit-touch-callout:none;
  -webkit-user-select:none;
  user-select:none;
}

input, textarea {
  -webkit-user-select: text;
  user-select: text;
}

html, body {
  height:100%;
  width:100%;
  overflow:hidden;
}

body {
  font-family:'IBM Plex Sans Arabic',sans-serif;
  background:var(--bg);
  color:var(--txt);
  display:flex;
  flex-direction:column;
  position:fixed;
  width:100%;
  height:100%;
}

/* â”€â”€ TOPBAR â”€â”€ */
#topbar {
  flex-shrink:0;
  background:rgba(13,17,23,.98);
  backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  padding:0 12px;
  height:58px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:relative;
  z-index:90;
}

.brand {
  display:flex;
  align-items:center;
  gap:8px;
}

.brand-icon {
  width:36px;
  height:36px;
  background:var(--amber);
  border-radius:9px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  box-shadow:0 0 18px var(--amberG);
}

.brand-title {
  font-size:15px;
  font-weight:700;
  color:#fff;
  line-height:1.2;
}

.brand-sub {
  font-size:9px;
  color:var(--txt3);
}

.stats {
  display:flex;
  gap:4px;
}

.stat {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:4px 8px;
  font-size:10px;
  color:var(--txt2);
  display:flex;
  align-items:center;
  gap:3px;
  font-family:'JetBrains Mono',monospace;
  white-space:nowrap;
}

.stat b {
  color:var(--amber);
  font-size:13px;
}

.stat.warn b { color:var(--amber); }
.stat.danger b { color:var(--red); }

/* â”€â”€ NAV â”€â”€ */
#nav {
  flex-shrink:0;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  background:var(--card);
  border-bottom:1px solid var(--border);
  position:relative;
  z-index:89;
}

.ntab {
  background:none;
  border:none;
  padding:12px 4px 10px;
  color:var(--txt3);
  font-family:'IBM Plex Sans Arabic',sans-serif;
  font-size:11px;
  font-weight:600;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:2px;
  border-bottom:2px solid transparent;
  transition:all .18s;
  -webkit-appearance:none;
}

.ntab .ni {
  font-size:20px;
  line-height:1;
}

.ntab:active {
  background:var(--card2);
}

.ntab.on {
  color:var(--amber);
  border-bottom-color:var(--amber);
  background:var(--card2);
}

/* â”€â”€ SCREENS â”€â”€ */
#wrap {
  flex:1;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  scroll-behavior:smooth;
}

.screen {
  display:none;
  padding:16px 12px 20px;
  min-height:100%;
}

.screen.on {
  display:block;
  animation:fu .22s ease;
}

@keyframes fu {
  from {
    opacity:0;
    transform:translateY(6px);
  }
  to {
    opacity:1;
    transform:translateY(0);
  }
}

/* â”€â”€ SECTION HEAD â”€â”€ */
.sh {
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  margin-bottom:14px;
}

.sh h2 {
  font-size:20px;
  font-weight:700;
  letter-spacing:-.5px;
}

.sh p {
  font-size:11px;
  color:var(--txt3);
  margin-top:2px;
}

/* â”€â”€ CARD â”€â”€ */
.box {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:16px;
  margin-bottom:14px;
}

/* â”€â”€ FIELDS â”€â”€ */
.fld {
  margin-bottom:12px;
}

.fld label {
  display:block;
  font-size:10px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:1px;
  color:var(--txt3);
  margin-bottom:4px;
}

.fld input,
.fld select {
  width:100%;
  background:var(--card2);
  border:1px solid var(--border);
  border-radius:var(--rs);
  padding:12px 13px;
  color:var(--txt);
  font-family:'IBM Plex Sans Arabic',sans-serif;
  font-size:15px;
  outline:none;
  transition:border .15s,box-shadow .15s;
  direction:rtl;
  -webkit-appearance:none;
  appearance:none;
}

.fld input:focus,
.fld select:focus {
  border-color:var(--amber);
  box-shadow:0 0 0 3px var(--amberD);
}

.fld input::placeholder {
  color:var(--txt3);
  font-size:13px;
}

.frow {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  border:none;
  border-radius:var(--rs);
  font-family:'IBM Plex Sans Arabic',sans-serif;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  transition:all .15s;
  padding:12px 16px;
  -webkit-appearance:none;
  appearance:none;
  touch-action:manipulation;
}

.btn:active {
  transform:scale(.97);
  opacity:.9;
}

.ba {
  background:var(--amber);
  color:#000;
  box-shadow:0 3px 14px var(--amberD);
}

.bg {
  background:var(--card2);
  color:var(--txt2);
  border:1px solid var(--border);
}

.br {
  background:var(--redD);
  color:var(--red);
  border:1px solid rgba(239,68,68,.25);
}

.brow {
  display:flex;
  gap:8px;
  margin-top:4px;
}

.brow .btn {
  flex:1;
}

/* â”€â”€ BADGES â”€â”€ */
.bdg {
  font-size:10px;
  font-weight:700;
  padding:3px 9px;
  border-radius:16px;
  white-space:nowrap;
}

.bdg-g {
  background:var(--greenD);
  color:var(--green);
  border:1px solid rgba(16,185,129,.3);
}

.bdg-a {
  background:var(--amberD);
  color:var(--amber);
  border:1px solid rgba(245,158,11,.3);
}

.bdg-r {
  background:var(--redD);
  color:var(--red);
  border:1px solid rgba(239,68,68,.3);
}

.daybdg {
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:4px 10px;
  border-radius:16px;
  font-size:11px;
  font-weight:700;
}

.d-g {
  background:var(--greenD);
  color:var(--green);
}

.d-a {
  background:var(--amberD);
  color:var(--amber);
}

.d-r {
  background:var(--redD);
  color:var(--red);
}

/* â”€â”€ SEARCH â”€â”€ */
.sbox {
  position:relative;
  margin-bottom:14px;
}

.sbox input {
  width:100%;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--rs);
  padding:12px 40px 12px 13px;
  color:var(--txt);
  font-family:'IBM Plex Sans Arabic',sans-serif;
  font-size:14px;
  outline:none;
  transition:border .15s,box-shadow .15s;
  -webkit-appearance:none;
}

.sbox input:focus {
  border-color:var(--amber);
  box-shadow:0 0 0 3px var(--amberD);
}

.sico {
  position:absolute;
  left:13px;
  top:50%;
  transform:translateY(-50%);
  font-size:15px;
  color:var(--txt3);
  pointer-events:none;
}

/* â”€â”€ ITEM CARD â”€â”€ */
.ic {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:14px;
  margin-bottom:10px;
  position:relative;
  overflow:hidden;
  transition:border-color .2s,transform .15s;
}

.ic::after {
  content:'';
  position:absolute;
  top:0;
  right:0;
  width:3px;
  height:100%;
  border-radius:0 var(--r) var(--r) 0;
  background:var(--green);
}

.ic.iwarn::after { background:var(--amber); }
.ic.iexp::after { background:var(--red); }

.ic:active {
  transform:scale(.99);
}

.ictop {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:10px;
}

.icname {
  font-size:14px;
  font-weight:700;
  flex:1;
  line-height:1.3;
  padding-left:8px;
}

.icmeta {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:6px;
}

.mr {
  display:flex;
  flex-direction:column;
  gap:2px;
}

.ml {
  font-size:9px;
  color:var(--txt3);
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.8px;
}

.mv {
  font-size:11px;
  font-weight:600;
  color:var(--txt2);
}

.mv.mono {
  font-family:'JetBrains Mono',monospace;
  color:var(--amber);
  font-size:11px;
}

.icbottom {
  display:flex;
  gap:6px;
  margin-top:12px;
  padding-top:10px;
  border-top:1px solid var(--border);
}

.icbottom .btn {
  padding:9px 10px;
  font-size:11px;
  flex:1;
}

/* â”€â”€ EMPTY â”€â”€ */
.empty {
  text-align:center;
  padding:40px 20px;
}

.empty .ei {
  font-size:48px;
  opacity:.2;
  margin-bottom:10px;
}

.empty h3 {
  font-size:16px;
  font-weight:700;
  margin-bottom:5px;
  color:var(--txt2);
}

.empty p {
  font-size:12px;
  color:var(--txt3);
}

/* â”€â”€ SCAN â”€â”€ */
.scan-box {
  background:var(--card);
  border:2px dashed var(--border);
  border-radius:var(--r);
  padding:20px 14px;
  text-align:center;
  margin-bottom:14px;
  transition:all .2s;
}

.scan-box.focused {
  border:2px solid var(--amber);
  background:var(--amberD);
  box-shadow:0 0 0 3px var(--amberD);
}

.scan-box h3 {
  font-size:15px;
  font-weight:700;
  margin-bottom:5px;
}

.scan-box p {
  font-size:11px;
  color:var(--txt3);
  margin-bottom:14px;
}

.sfield {
  width:100%;
  background:var(--card2);
  border:1px solid var(--border);
  border-radius:var(--rs);
  padding:14px;
  text-align:center;
  color:var(--txt);
  font-family:'JetBrains Mono',monospace;
  font-size:15px;
  letter-spacing:1px;
  outline:none;
  transition:border .15s,box-shadow .15s;
  -webkit-appearance:none;
}

.sfield:focus {
  border-color:var(--amber);
  box-shadow:0 0 0 3px var(--amberD);
}

.nf-msg {
  display:none;
  margin-top:10px;
  background:var(--redD);
  border:1px solid rgba(239,68,68,.3);
  border-radius:var(--rs);
  padding:10px;
  color:var(--red);
  font-size:13px;
  font-weight:600;
  text-align:center;
}

.sr-hero {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--r);
  padding:20px 14px;
  text-align:center;
  margin-bottom:12px;
}

.sr-name {
  font-size:20px;
  font-weight:700;
  letter-spacing:-.5px;
  line-height:1.3;
  margin:8px 0;
}

.sr-batch {
  font-family:'JetBrains Mono',monospace;
  font-size:12px;
  color:var(--amber);
  background:var(--amberD);
  border:1px solid var(--amberG);
  border-radius:6px;
  padding:4px 12px;
  display:inline-block;
  margin-bottom:10px;
}

.sr-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:12px;
}

.sri {
  background:var(--card2);
  border:1px solid var(--border);
  border-radius:var(--rs);
  padding:12px;
  text-align:center;
}

.sri .si {
  font-size:18px;
  margin-bottom:4px;
}

.sri .sl {
  font-size:9px;
  color:var(--txt3);
  text-transform:uppercase;
  letter-spacing:.8px;
  margin-bottom:2px;
}

.sri .sv {
  font-size:12px;
  font-weight:700;
}

/* â”€â”€ OVERLAY (bottom sheet) â”€â”€ */
#overlay {
  display:none;
  position:fixed;
  inset:0;
  z-index:200;
  background:rgba(0,0,0,.85);
  backdrop-filter:blur(14px);
  align-items:flex-end;
}

#overlay.on {
  display:flex;
}

.sheet {
  background:var(--card);
  border-top:1px solid var(--border);
  border-radius:22px 22px 0 0;
  padding:18px 16px 30px;
  width:100%;
  max-height:85vh;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  animation:su .28s cubic-bezier(.32,.72,0,1);
}

@keyframes su {
  from { transform:translateY(100%); }
  to { transform:translateY(0); }
}

.sheet-handle {
  width:38px;
  height:4px;
  background:var(--border);
  border-radius:2px;
  margin:0 auto 18px;
}

.sheet-title {
  font-size:16px;
  font-weight:700;
  text-align:center;
  margin-bottom:16px;
}

.qr-center {
  display:flex;
  justify-content:center;
  margin-bottom:16px;
}

.qr-frame {
  background:#fff;
  padding:12px;
  border-radius:14px;
  box-shadow:0 0 36px var(--amberG);
}

.qr-frame img,
.qr-frame canvas {
  display:block;
  width:160px;
  height:160px;
}

.qr-meta {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-bottom:16px;
}

.qm {
  background:var(--card2);
  border:1px solid var(--border);
  border-radius:var(--rs);
  padding:10px;
}

.qm .ql {
  font-size:9px;
  color:var(--txt3);
  text-transform:uppercase;
  letter-spacing:.8px;
  margin-bottom:2px;
}

.qm .qv {
  font-size:12px;
  font-weight:700;
}

.qm .qv.mono {
  font-family:'JetBrains Mono',monospace;
  color:var(--amber);
  font-size:11px;
}

.sheet-btns {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}

.sheet-btns .btn {
  padding:12px;
}

/* â”€â”€ TOAST â”€â”€ */
#toast {
  position:fixed;
  bottom:25px;
  left:50%;
  transform:translateX(-50%);
  background:var(--card2);
  border:1px solid var(--border);
  border-radius:18px;
  padding:9px 18px;
  font-size:13px;
  font-weight:600;
  box-shadow:0 6px 20px rgba(0,0,0,.5);
  z-index:300;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s;
  white-space:nowrap;
  max-width:80%;
  overflow:hidden;
  text-overflow:ellipsis;
}

#toast.on {
  opacity:1;
}

/* â”€â”€ INSTALL BUTTON â”€â”€ */
#install-btn {
  position:fixed;
  bottom:25px;
  right:25px;
  background:var(--amber);
  color:#000;
  border:none;
  border-radius:30px;
  padding:12px 20px;
  font-size:14px;
  font-weight:700;
  box-shadow:0 4px 15px rgba(245,158,11,.4);
  z-index:100;
  cursor:pointer;
  display:none;
  align-items:center;
  gap:6px;
  border:1px solid var(--amberG);
  animation:pulse 2s infinite;
}

@keyframes pulse {
  0% { transform:scale(1); }
  50% { transform:scale(1.05); }
  100% { transform:scale(1); }
}

#install-btn:active {
  transform:scale(.95);
}

/* â”€â”€ OFFLINE BADGE â”€â”€ */
#offline-badge {
  position:fixed;
  top:60px;
  left:12px;
  background:var(--redD);
  color:var(--red);
  border:1px solid rgba(239,68,68,.3);
  border-radius:16px;
  padding:4px 12px;
  font-size:10px;
  font-weight:700;
  z-index:95;
  display:none;
  backdrop-filter:blur(10px);
}

/* â”€â”€ MEDIA QUERIES â”€â”€ */
@media (min-width:600px) {
  #topbar, #nav {
    padding-left:20px;
    padding-right:20px;
  }
  
  .screen {
    padding:20px 20px 30px;
    max-width:600px;
    margin:0 auto;
  }
  
  .sr-grid {
    grid-template-columns:1fr 1fr 1fr;
  }
  
  .qr-meta {
    grid-template-columns:1fr 1fr 1fr;
  }
}

/* Touch optimizations */
@media (hover:none) and (pointer:coarse) {
  .btn, .ntab, .ic {
    cursor:default;
  }
  
  .btn {
    min-height:44px;
  }
  
  input, select, .sfield {
    font-size:16px;
  }
}
</style>
</head>
<body>

<!-- OFFLINE BADGE -->
<div id="offline-badge">ğŸ“´ ØºÙŠØ± Ù…ØªØµÙ„</div>

<!-- INSTALL BUTTON -->
<button id="install-btn" style="display:none">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

<!-- TOPBAR -->
<div id="topbar">
  <div class="brand">
    <div class="brand-icon">ğŸ“¦</div>
    <div>
      <div class="brand-title">QR Rack</div>
      <div class="brand-sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
    </div>
  </div>
  <div class="stats">
    <div class="stat"><b id="s-total">0</b></div>
    <div class="stat warn" id="s-warn-pill" style="display:none"><b id="s-warn">0</b>âš ï¸</div>
    <div class="stat danger" id="s-exp-pill" style="display:none"><b id="s-exp">0</b>ğŸ”´</div>
  </div>
</div>

<!-- NAV -->
<div id="nav">
  <button class="ntab on" id="tab-add">
    <span class="ni">â•</span>Ø¥Ø¶Ø§ÙØ©
  </button>
  <button class="ntab" id="tab-list">
    <span class="ni">ğŸ“‹</span>Ø§Ù„Ø£ØµÙ†Ø§Ù
  </button>
  <button class="ntab" id="tab-scan">
    <span class="ni">ğŸ”</span>Ù…Ø³Ø­
  </button>
</div>

<!-- SCREENS WRAPPER -->
<div id="wrap">

  <!-- ADD SCREEN -->
  <div class="screen on" id="sc-add">
    <div class="sh">
      <div>
        <h2>ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h2>
        <p>ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ QR ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
      </div>
    </div>

    <div class="box">
      <div class="fld">
        <label>ğŸ·ï¸ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù *</label>
        <input type="text" id="f-name" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙ„ÙˆØ± Ø§Ù„ØµÙˆØ¯ÙŠÙˆÙ…" autocomplete="off">
      </div>
      <div class="fld">
        <label>ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ØªØ´ *</label>
        <input type="text" id="f-batch" placeholder="Ù…Ø«Ø§Ù„: BT-2024-001" autocomplete="off">
      </div>
      <div class="frow">
        <div class="fld">
          <label>ğŸ“… Ø§Ù„Ø¥Ù†ØªØ§Ø¬ *</label>
          <input type="date" id="f-mfg">
        </div>
        <div class="fld">
          <label>â³ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
          <input type="date" id="f-exp">
        </div>
      </div>
      <div class="fld">
        <label>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <input type="text" id="f-notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" autocomplete="off">
      </div>
      <div class="brow">
        <button class="btn ba" id="btn-add">âœ¨ Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btn bg" id="btn-clear">ğŸ”„ Ù…Ø³Ø­</button>
      </div>
    </div>

    <!-- Preview after add -->
    <div class="box" id="preview-box" style="display:none">
      <div style="text-align:center">
        <div style="font-size:11px;color:var(--txt3);margin-bottom:8px">âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©</div>
        <div id="pv-name" style="font-size:16px;font-weight:700;margin-bottom:10px"></div>
        <div class="qr-center">
          <div class="qr-frame" style="padding:8px">
            <div id="pv-qr"></div>
          </div>
        </div>
        <div id="pv-meta" style="font-size:11px;color:var(--txt3);margin-top:10px;margin-bottom:12px"></div>
        <div class="brow">
          <button class="btn ba" id="btn-pv-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn bg" id="btn-pv-list">ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LIST SCREEN -->
  <div class="screen" id="sc-list">
    <div class="sh">
      <div><h2>Ø§Ù„Ø£ØµÙ†Ø§Ù</h2></div>
      <button class="btn bg" id="btn-print-all" style="padding:8px 12px;font-size:11px">ğŸ–¨ï¸ Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="sbox">
      <input type="text" id="search-inp" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§ØªØ´..." autocomplete="off">
      <span class="sico">ğŸ”</span>
    </div>
    <div id="list-body"></div>
  </div>

  <!-- SCAN SCREEN -->
  <div class="screen" id="sc-scan">
    <div class="sh">
      <div>
        <h2>Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² QR Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ØªØ´</p>
      </div>
    </div>

    <div class="scan-box" id="scan-box">
      <h3>ğŸ“± Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø­</h3>
      <p>Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ØªØ´ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ù…Ø­ØªÙˆÙ‰ QR</p>
      <input type="text" class="sfield" id="scan-inp" placeholder="Ù…Ø«Ø§Ù„: BT-2024-001" autocomplete="off">
      <div class="nf-msg" id="nf-msg">âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>
    </div>

    <div id="scan-result" style="display:none"></div>
  </div>
</div>

<!-- OVERLAY - QR SHEET -->
<div id="overlay">
  <div class="sheet" id="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sh-title"></div>
    <div class="qr-center">
      <div class="qr-frame">
        <div id="sh-qr"></div>
      </div>
    </div>
    <div class="qr-meta" id="sh-meta"></div>
    <div class="sheet-btns">
      <button class="btn ba" id="sh-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn bg" id="sh-close">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script src="qrcode.min.js"></script>

<script>
// ============================================
// MAIN APPLICATION CODE
// ============================================

// State management
let items = [];
try {
  const saved = localStorage.getItem('qr-rack-items');
  items = saved ? JSON.parse(saved) : [];
} catch(e) {
  console.warn('Failed to load items', e);
  items = [];
}

// DOM Elements
const elements = {
  total: document.getElementById('s-total'),
  warn: document.getElementById('s-warn'),
  exp: document.getElementById('s-exp'),
  warnPill: document.getElementById('s-warn-pill'),
  expPill: document.getElementById('s-exp-pill'),
  toast: document.getElementById('toast'),
  overlay: document.getElementById('overlay'),
  installBtn: document.getElementById('install-btn'),
  offlineBadge: document.getElementById('offline-badge')
};

// Save to localStorage
function saveItems() {
  try {
    localStorage.setItem('qr-rack-items', JSON.stringify(items));
    updateStats();
  } catch(e) {
    showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'var(--red)');
  }
}

// Date helpers
function getDaysLeft(expDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const exp = new Date(expDate);
  exp.setHours(0, 0, 0, 0);
  return Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
}

function getStatus(expDate) {
  const days = getDaysLeft(expDate);
  if (days < 0) {
    return { class: 'iexp', badge: 'bdg-r', label: 'Ù…Ù†ØªÙ‡ÙŠ â›”', dayClass: 'd-r', dayLabel: 'Ù…Ù†ØªÙ‡ÙŠ' };
  }
  if (days <= 30) {
    return { class: 'iwarn', badge: 'bdg-a', label: `${days} ÙŠÙˆÙ… âš ï¸`, dayClass: 'd-a', dayLabel: `${days} ÙŠÙˆÙ…` };
  }
  return { class: '', badge: 'bdg-g', label: 'ØµØ§Ù„Ø­ âœ…', dayClass: 'd-g', dayLabel: `${days} ÙŠÙˆÙ…` };
}

function formatDate(dateStr) {
  if (!dateStr) return 'â€”';
  try {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch {
    return dateStr;
  }
}

function getQRText(item) {
  return `ID:${item.id}|Ø§Ø³Ù…:${item.name}|Ø¨Ø§ØªØ´:${item.batch}|Ø¥Ù†ØªØ§Ø¬:${item.mfg}|Ø§Ù†ØªÙ‡Ø§Ø¡:${item.exp}|Ù…Ù„Ø§Ø­Ø¸Ø§Øª:${item.notes || ''}`;
}

function generateQR(el, item, size = 150) {
  if (!el) return;
  try {
    new QRCode(el, {
      text: getQRText(item),
      width: size,
      height: size,
      colorDark: '#000000',
      colorLight: '#ffffff'
    });
  } catch(e) {
    console.warn('QR generation failed', e);
    el.innerHTML = '<div style="color:var(--red)">âš ï¸ Ø®Ø·Ø£ ÙÙŠ QR</div>';
  }
}

function showToast(message, color = 'var(--green)') {
  if (!elements.toast) return;
  elements.toast.textContent = message;
  elements.toast.style.color = color;
  elements.toast.classList.add('on');
  clearTimeout(elements.toast._timer);
  elements.toast._timer = setTimeout(() => {
    elements.toast.classList.remove('on');
  }, 2000);
}

function updateStats() {
  const total = items.length;
  const expired = items.filter(i => getDaysLeft(i.exp) < 0).length;
  const warning = items.filter(i => {
    const d = getDaysLeft(i.exp);
    return d >= 0 && d <= 30;
  }).length;

  if (elements.total) elements.total.textContent = total;
  if (elements.warn) elements.warn.textContent = warning;
  if (elements.exp) elements.exp.textContent = expired;
  
  if (elements.warnPill) elements.warnPill.style.display = warning > 0 ? 'flex' : 'none';
  if (elements.expPill) elements.expPill.style.display = expired > 0 ? 'flex' : 'none';
}

// Navigation
const screens = ['add', 'list', 'scan'];
const tabs = [
  document.getElementById('tab-add'),
  document.getElementById('tab-list'),
  document.getElementById('tab-scan')
];
const screenElements = [
  document.getElementById('sc-add'),
  document.getElementById('sc-list'),
  document.getElementById('sc-scan')
];

function navigateTo(screenId) {
  screens.forEach((s, i) => {
    const isActive = s === screenId;
    if (tabs[i]) tabs[i].classList.toggle('on', isActive);
    if (screenElements[i]) screenElements[i].classList.toggle('on', isActive);
  });
  
  if (screenId === 'list') renderList();
  if (screenId === 'scan') setTimeout(() => document.getElementById('scan-inp')?.focus(), 200);
}

// Event listeners for tabs
tabs.forEach((tab, i) => {
  if (tab) {
    tab.addEventListener('click', (e) => {
      e.preventDefault();
      navigateTo(screens[i]);
    });
  }
});

// ========== ADD SCREEN ==========
document.getElementById('btn-add')?.addEventListener('click', () => {
  const name = document.getElementById('f-name')?.value.trim();
  const batch = document.getElementById('f-batch')?.value.trim();
  const mfg = document.getElementById('f-mfg')?.value;
  const exp = document.getElementById('f-exp')?.value;
  const notes = document.getElementById('f-notes')?.value.trim();

  if (!name || !batch || !mfg || !exp) {
    showToast('âš ï¸ Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'var(--red)');
    return;
  }

  const item = {
    id: Date.now().toString(),
    name,
    batch,
    mfg,
    exp,
    notes: notes || ''
  };

  items.unshift(item);
  saveItems();

  // Clear form
  ['f-name', 'f-batch', 'f-mfg', 'f-exp', 'f-notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Show preview
  const previewBox = document.getElementById('preview-box');
  if (previewBox) {
    previewBox.style.display = 'block';
    
    const pvName = document.getElementById('pv-name');
    if (pvName) pvName.textContent = item.name;
    
    const pvQR = document.getElementById('pv-qr');
    if (pvQR) {
      pvQR.innerHTML = '';
      setTimeout(() => generateQR(pvQR, item, 130), 50);
    }
    
    const status = getStatus(item.exp);
    const pvMeta = document.getElementById('pv-meta');
    if (pvMeta) {
      pvMeta.innerHTML = `
        <span style="color:var(--amber);font-family:monospace">${item.batch}</span>
        <span class="bdg ${status.badge}">${status.label}</span><br>
        ğŸ“… ${formatDate(item.mfg)} â†’ â³ ${formatDate(item.exp)}
      `;
    }
    
    document.getElementById('btn-pv-print').onclick = () => printItem(item.id);
  }

  showToast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
});

document.getElementById('btn-clear')?.addEventListener('click', () => {
  ['f-name', 'f-batch', 'f-mfg', 'f-exp', 'f-notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const previewBox = document.getElementById('preview-box');
  if (previewBox) previewBox.style.display = 'none';
});

document.getElementById('btn-pv-list')?.addEventListener('click', () => {
  navigateTo('list');
});

// ========== LIST SCREEN ==========
function renderList() {
  const searchInput = document.getElementById('search-inp');
  const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
  
  const filtered = searchTerm
    ? items.filter(i => 
        i.name.toLowerCase().includes(searchTerm) || 
        i.batch.toLowerCase().includes(searchTerm)
      )
    : items;
  
  const listBody = document.getElementById('list-body');
  if (!listBody) return;
  
  if (filtered.length === 0) {
    listBody.innerHTML = `
      <div class="empty">
        <div class="ei">${searchTerm ? 'ğŸ”' : 'ğŸ“¦'}</div>
        <h3>${searchTerm ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù'}</h3>
        <p>${searchTerm ? 'Ø¬Ø±Ø¨ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ©' : 'Ø£Ø¶Ù ØµÙ†ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹'}</p>
      </div>
    `;
    return;
  }
  
  listBody.innerHTML = filtered.map(item => {
    const status = getStatus(item.exp);
    const days = getDaysLeft(item.exp);
    
    return `
      <div class="ic ${status.class}">
        <div class="ictop">
          <div class="icname">${escapeHTML(item.name)}</div>
          <span class="bdg ${status.badge}">${status.label}</span>
        </div>
        <div class="icmeta">
          <div class="mr">
            <div class="ml">Ø§Ù„Ø¨Ø§ØªØ´</div>
            <div class="mv mono">${escapeHTML(item.batch)}</div>
          </div>
          <div class="mr">
            <div class="ml">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div class="mv"><span class="daybdg ${status.dayClass}">${status.dayLabel}</span></div>
          </div>
          <div class="mr">
            <div class="ml">Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div>
            <div class="mv">${formatDate(item.mfg)}</div>
          </div>
          <div class="mr">
            <div class="ml">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
            <div class="mv">${formatDate(item.exp)}</div>
          </div>
        </div>
        <div class="icbottom">
          <button class="btn ba" onclick="showSheet('${item.id}')">ğŸ” QR</button>
          <button class="btn bg" onclick="printItem('${item.id}')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn br" onclick="deleteItem('${item.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }).join('');
}

// Simple HTML escape
function escapeHTML(str) {
  return String(str).replace(/[&<>"]/g, function(m) {
    if (m === '&') return '&amp;';
    if (m === '<') return '&lt;';
    if (m === '>') return '&gt;';
    if (m === '"') return '&quot;';
    return m;
  });
}

// Search input
document.getElementById('search-inp')?.addEventListener('input', renderList);

// ========== DELETE ITEM ==========
window.deleteItem = function(id) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')) return;
  items = items.filter(i => i.id !== id);
  saveItems();
  renderList();
  showToast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
};

// ========== BOTTOM SHEET ==========
window.showSheet = function(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  
  const status = getStatus(item.exp);
  const days = getDaysLeft(item.exp);
  
  const titleEl = document.getElementById('sh-title');
  if (titleEl) titleEl.textContent = item.name;
  
  const qrEl = document.getElementById('sh-qr');
  if (qrEl) {
    qrEl.innerHTML = '';
    setTimeout(() => generateQR(qrEl, item, 180), 50);
  }
  
  const metaEl = document.getElementById('sh-meta');
  if (metaEl) {
    metaEl.innerHTML = `
      <div class="qm"><div class="ql">Ø§Ù„Ø¨Ø§ØªØ´</div><div class="qv mono">${escapeHTML(item.batch)}</div></div>
      <div class="qm"><div class="ql">Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div><div class="qv">${formatDate(item.mfg)}</div></div>
      <div class="qm"><div class="ql">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div><div class="qv">${formatDate(item.exp)}</div></div>
      <div class="qm"><div class="ql">Ø§Ù„Ø­Ø§Ù„Ø©</div><div class="qv"><span class="bdg ${status.badge}">${status.label}</span></div></div>
      <div class="qm"><div class="ql">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div class="qv"><span class="daybdg ${status.dayClass}">${status.dayLabel}</span></div></div>
      ${item.notes ? `<div class="qm" style="grid-column:1/-1"><div class="ql">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div><div class="qv">${escapeHTML(item.notes)}</div></div>` : ''}
    `;
  }
  
  document.getElementById('sh-print').onclick = () => printItem(item.id);
  
  const overlay = document.getElementById('overlay');
  if (overlay) overlay.classList.add('on');
};

// Close sheet
document.getElementById('sh-close')?.addEventListener('click', () => {
  document.getElementById('overlay')?.classList.remove('on');
});

document.getElementById('overlay')?.addEventListener('click', (e) => {
  if (e.target === e.currentTarget) {
    e.currentTarget.classList.remove('on');
  }
});

// ========== PRINT FUNCTIONS ==========
function buildLabel(item) {
  return new Promise((resolve) => {
    const temp = document.createElement('div');
    temp.style.cssText = 'position:absolute;left:-9999px;top:0;width:200px';
    document.body.appendChild(temp);
    
    new QRCode(temp, {
      text: getQRText(item),
      width: 80,
      height: 80,
      colorDark: '#000000',
      colorLight: '#ffffff'
    });
    
    setTimeout(() => {
      const canvas = temp.querySelector('canvas');
      const imgSrc = canvas ? canvas.toDataURL('image/png') : '';
      document.body.removeChild(temp);
      
      const label = `
        <div style="display:inline-block;direction:rtl;font-family:Arial,sans-serif;
        background:#fff;color:#000;border:2px solid #000;border-radius:6px;
        padding:8px;width:80mm;vertical-align:top;margin:3mm;page-break-inside:avoid">
          <div style="font-size:14pt;font-weight:900;text-align:center;
          border-bottom:1.5px solid #000;padding-bottom:4px;margin-bottom:6px">
            ${escapeHTML(item.name)}
          </div>
          <div style="display:flex;gap:8px;align-items:flex-start">
            <div style="flex:1;font-size:9pt;line-height:1.8">
              <div><strong>Ø§Ù„Ø¨Ø§ØªØ´:</strong> <span style="font-family:monospace">${escapeHTML(item.batch)}</span></div>
              <div><strong>Ø§Ù„Ø¥Ù†ØªØ§Ø¬:</strong> ${formatDate(item.mfg)}</div>
              <div><strong>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> ${formatDate(item.exp)}</div>
              ${item.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${escapeHTML(item.notes)}</div>` : ''}
            </div>
            <div style="flex-shrink:0">${imgSrc ? `<img src="${imgSrc}" width="80" height="80">` : ''}</div>
          </div>
        </div>
      `;
      resolve(label);
    }, 300);
  });
}

function openPrintWindow(html, title) {
  const win = window.open('', '_blank');
  if (!win) {
    showToast('âš ï¸ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©', 'var(--red)');
    return;
  }
  win.document.write(`
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>${escapeHTML(title)}</title>
      <style>
        body { margin:5mm; background:#fff; }
        @page { margin:3mm; size: auto; }
        @media print { body { margin:0; } }
      </style>
    </head>
    <body>${html}</body>
    </html>
  `);
  win.document.close();
  win.focus();
  setTimeout(() => {
    win.print();
    win.close();
  }, 500);
}

window.printItem = function(id) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  showToast('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...');
  buildLabel(item).then(html => {
    openPrintWindow(html, `Ø·Ø¨Ø§Ø¹Ø© - ${item.name}`);
    document.getElementById('overlay')?.classList.remove('on');
  });
};

document.getElementById('btn-print-all')?.addEventListener('click', () => {
  if (items.length === 0) {
    showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù', 'var(--red)');
    return;
  }
  showToast(`â³ ØªØ¬Ù‡ÙŠØ² ${items.length} Ù…Ù„ØµÙ‚...`);
  Promise.all(items.map(item => buildLabel(item))).then(labels => {
    openPrintWindow(labels.join(''), 'Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù');
  });
});

// ========== SCAN SCREEN ==========
const scanInput = document.getElementById('scan-inp');
const scanBox = document.getElementById('scan-box');
const nfMsg = document.getElementById('nf-msg');
const scanResult = document.getElementById('scan-result');

if (scanInput) {
  scanInput.addEventListener('focus', () => scanBox?.classList.add('focused'));
  scanInput.addEventListener('blur', () => scanBox?.classList.remove('focused'));
  
  scanInput.addEventListener('input', () => {
    const val = scanInput.value.trim();
    performScan(val);
  });
}

function performScan(val) {
  if (!val) {
    if (nfMsg) nfMsg.style.display = 'none';
    if (scanResult) scanResult.style.display = 'none';
    return;
  }
  
  let found = null;
  
  // Try to parse as QR text
  if (val.includes('ID:') && val.includes('Ø¨Ø§ØªØ´:')) {
    const match = val.match(/ID:([^|]+)/);
    if (match) {
      found = items.find(i => i.id === match[1]);
    }
  }
  
  // Try batch exact match
  if (!found) {
    found = items.find(i => i.batch.toLowerCase() === val.toLowerCase());
  }
  
  // Try batch partial match
  if (!found && val.length >= 2) {
    found = items.find(i => i.batch.toLowerCase().includes(val.toLowerCase()));
  }
  
  // Try name match
  if (!found && val.length >= 2) {
    found = items.find(i => i.name.toLowerCase().includes(val.toLowerCase()));
  }
  
  if (!found) {
    if (nfMsg) nfMsg.style.display = 'block';
    if (scanResult) scanResult.style.display = 'none';
    return;
  }
  
  if (nfMsg) nfMsg.style.display = 'none';
  
  const status = getStatus(found.exp);
  const days = getDaysLeft(found.exp);
  const expStyle = days < 0 ? 'border:1px solid var(--red)' : days <= 30 ? 'border:1px solid var(--amber)' : '';
  
  if (scanResult) {
    scanResult.innerHTML = `
      <div class="sr-hero">
        <span class="bdg ${status.badge}" style="font-size:11px;padding:4px 12px">${status.label}</span>
        <div class="sr-name">${escapeHTML(found.name)}</div>
        <div class="sr-batch">${escapeHTML(found.batch)}</div>
        ${found.notes ? `<div style="font-size:11px;color:var(--txt3);margin-top:4px">ğŸ“ ${escapeHTML(found.notes)}</div>` : ''}
        <div class="sr-grid">
          <div class="sri">
            <div class="si">ğŸ­</div>
            <div class="sl">Ø§Ù„Ø¥Ù†ØªØ§Ø¬</div>
            <div class="sv">${formatDate(found.mfg)}</div>
          </div>
          <div class="sri" style="${expStyle}">
            <div class="si">â³</div>
            <div class="sl">Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
            <div class="sv">${formatDate(found.exp)}</div>
          </div>
          <div class="sri">
            <div class="si">ğŸ“†</div>
            <div class="sl">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div class="sv"><span class="daybdg ${status.dayClass}">${status.dayLabel}</span></div>
          </div>
        </div>
      </div>
    `;
    scanResult.style.display = 'block';
  }
}

// ========== OFFLINE / PWA ==========
// Check online status
function updateOnlineStatus() {
  const isOnline = navigator.onLine;
  if (elements.offlineBadge) {
    elements.offlineBadge.style.display = isOnline ? 'none' : 'block';
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// PWA Installation
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  if (elements.installBtn) elements.installBtn.style.display = 'flex';
});

if (elements.installBtn) {
  elements.installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') {
      elements.installBtn.style.display = 'none';
    }
    deferredPrompt = null;
  });
}

window.addEventListener('appinstalled', () => {
  if (elements.installBtn) elements.installBtn.style.display = 'none';
  showToast('âœ… ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­');
});

// ========== INITIALIZATION ==========
updateStats();
renderList();

// Set min dates for date inputs
const today = new Date().toISOString().split('T')[0];
const mfgInput = document.getElementById('f-mfg');
const expInput = document.getElementById('f-exp');
if (mfgInput) mfgInput.max = today;
if (expInput) expInput.min = today;

// Clear preview on page load
document.getElementById('preview-box')?.style.setProperty('display', 'none');

// Export for debugging (optional)
window.appItems = items;
</script>



</body>
</html>